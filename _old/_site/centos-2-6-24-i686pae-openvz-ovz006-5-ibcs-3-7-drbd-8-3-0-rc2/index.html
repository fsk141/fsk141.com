
<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<title>CentOS 2.6.24 (i686PAE) | OpenVZ ovz006.5 | DRBD 8.3.0 | IBCS 3.7</title>
		
		<meta name="author" content="Jonny">
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<!-- HTML5 for IE -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
			<![endif]-->

	    <!-- Style -->
	    <link href="/assets/themes/fsk141/css/bootstrap.min.css" rel="stylesheet">
		<link href="/assets/themes/fsk141/css/bootstrap-responsive.min.css" rel="stylesheet">
		<link href="/assets/themes/fsk141/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
		<link href="/assets/themes/fsk141/css/pygmentize.css" rel="stylesheet">

		<!-- apple icons go here -->
	</head>

	<body>
		<div class="container-fluid">
			<div class="row-fluid">
			  <div class="span3 well">
				<h1><a class="brand" href="/">Fsk141</a></h1>
				<h3 class="h2link"></h2>
				<h3 class="h2link"></h2>
				<h3 class="h2link">


  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
      
    
  
    
  
    
      
    
  
    
      
    
  


</h2>
				<br>
				<div class="misc vcard">
					<h4>about</h4>
					<ul>
						<li class="contact"><address><span class="author fn n">Jonny</span> - <span class="fn email">jonny@fsk141.com</span></address></li>
						<li class="rss"><a href="http://feeds.feedburner.com/Fsk141">Subscribe to RSS Feed</a></li>
						<li class="github"><a href="http://github.com/fsk141/" rel="me">github.com/fsk141</a></li>
						<li class="twitter"><a href="http://twitter.com/fsk141/" rel="me">twitter.com/fsk141</a></li>
						<!-- <li class="reddit"><a href="http://reddit.com/user/fsk141/" rel="me">reddit.com/user/fsk141</a></li> -->
						<!-- <li class="flickr"><a href="http://flickr.com/photos/fsk141/" rel="me">flickr.com/photos/fsk141</a></li> -->
						<li class="lastfm"><a href="http://last.fm/user/fsk141/" rel="me">last.fm/user/fsk141</a></li>
						<li class="btc_donate">Donate some btc's:<br />
							<span style="font-size: 0.5em;">
							<script src="http://coinwidget.com/widget/coin.js"></script>
							<script>
							CoinWidgetCom.go({
								wallet_address: "1ByZeEBE2wtUabcAhgPEp7yjttFJJZWDdT"
								, currency: "bitcoin"
								, counter: "count"
								, alignment: "bl"
								, qrcode: true
								, auto_show: false
								, lbl_button: "Donate"
								, lbl_address: "BTC Address:"
								, lbl_count: "donations"
								, lbl_amount: "BTC"
							});
							</script>
							</span></li>
					</ul>
					<ul class="tag_box inline">
						
						


  
     
    	<li><a href="/categories.html#programming-ref">
    		programming <span>11</span>
    	</a></li>
     
    	<li><a href="/categories.html#software-ref">
    		software <span>16</span>
    	</a></li>
     
    	<li><a href="/categories.html#zfs-ref">
    		zfs <span>4</span>
    	</a></li>
     
    	<li><a href="/categories.html#linux-ref">
    		linux <span>50</span>
    	</a></li>
     
    	<li><a href="/categories.html#opensolaris-ref">
    		opensolaris <span>9</span>
    	</a></li>
     
    	<li><a href="/categories.html#networking-ref">
    		networking <span>9</span>
    	</a></li>
     
    	<li><a href="/categories.html#hardware-ref">
    		hardware <span>9</span>
    	</a></li>
     
    	<li><a href="/categories.html#homebrew-ref">
    		homebrew <span>3</span>
    	</a></li>
     
    	<li><a href="/categories.html#other stuff-ref">
    		other stuff <span>2</span>
    	</a></li>
     
    	<li><a href="/categories.html#tutorials-ref">
    		tutorials <span>8</span>
    	</a></li>
     
    	<li><a href="/categories.html#mac-ref">
    		mac <span>3</span>
    	</a></li>
     
    	<li><a href="/categories.html#photography-ref">
    		photography <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#kindle-ref">
    		kindle <span>2</span>
    	</a></li>
     
    	<li><a href="/categories.html#reviews-ref">
    		reviews <span>3</span>
    	</a></li>
     
    	<li><a href="/categories.html#bitcoin-ref">
    		bitcoin <span>2</span>
    	</a></li>
    
  


					</ul>
				</div>
				<p>&copy; Jonny 2013 with help from <a href="http://jekyllbootstrap.com">Jekyll Bootstrap</a></p>
			  </div>

			  <div class="offset-1" style="padding-top:20px;">
				  
<div class="">
	<h1>CentOS 2.6.24 (i686PAE) | OpenVZ ovz006.5 | DRBD 8.3.0 | IBCS 3.7 <small></small></h1>
</div>

<div class="row">
  <div class="span8">
    <p>The goal is to have an i686 kernel with 4GB+ memory support (PAE) with OpenVZ, IBCS, and DRBD.</p>

<p>Environment:
<a href="http://www.dell.com/content/products/productdetails.aspx/pedge_2900_3">Dell 2900</a>
-8 Cores (1.60Ghz)
-24GB RAM</p>

<p>Operating System:
CentOS 5</p>

<p>Lets start by making ourselves a working directory:</p>

<pre><code>mkdir -p /usr/src/kernels/2.6.24_vz_drbd_ibcs/src
cd /usr/src/kernels/2.6.24_vz_drbd_ibcs/src
</code></pre>

<p>Then we need to collect all the parts to build the patched kernel/modules:</p>

<pre><code>wget http://www.kernel.org/pub/linux/kernel/v2.6/linux-2.6.24.tar.gz
wget http://oss.linbit.com/drbd/8.3/drbd-8.3.0.tar.gz
wget http://voxel.dl.sourceforge.net/sourceforge/linux-abi/ibcs-3_7.tgz
wget http://download.openvz.org/kernel/branches/2.6.24/2.6.24-ovz006.5/patches/patch-ovz006.5-combined.gz
wget http://download.openvz.org/kernel/branches/2.6.24/2.6.24-ovz006.5/configs/kernel-2.6.24-i686-PAE.config.ovz
</code></pre>

<p>Now that we have all the pieces we need lets start extractin &amp; patchin. BTW, I’ll start all the command blocks with a pwd to show you where I am…:</p>

<pre><code>pwd
/usr/src/kernels/2.6.24_vz_drbd_ibcs/src
tar xzf linux-2.6.24.tar.gz -C ..
tar xzf drbd-8.3.0.tar.gz -C ..
mkdir ../ibcs
tar xzf ibcs-3_7.tgz -C ../ibcs
cp patch-ovz006.5-combined.gz ..
cd ..
</code></pre>

<p>Ok stay calm, I just put all the source files in /src, and will build the kernel in 2.6.24_vz_drbd_ibcs.</p>

<pre><code>pwd
/usr/src/kernels/2.6.24_vz_drbd_ibcs
gunzip -c patch-ovz006.5-combined.gz | patch -p0 patch-ovz006.5-combined.gz
</code></pre>

<p>Lets continue by patching in drbd. You have to actually patch this in as opposed to building it as a module since that doesn’t work.</p>

<pre><code>pwd
/usr/src/kernels/2.6.24_vz_drbd_ibcs
cd drbd-8.3.0
make KDIR=/usr/src/kernels/2.6.24_vz_drbd_ibcs/linux-2.6.24 kernel-patch
cp patch-linux-2.6.24-drbd-8.3.0 ..
cd ..
patch -p0 &lt; patch-linux-2.6.24-drbd-8.3.0




pwd
/usr/src/kernels/2.6.24_vz_drbd_ibcs
cd linux-2.6.24
cp ../src/kernel-2.6.24-i686-PAE.config.ovz ./.config
make menuconfig
</code></pre>

<p>After you’re dropped into menuconfig you need to set drbd to(to compile drbd into the kernel)</p>

<pre><code>Device Drivers &gt; Block devices &gt;     DRBD Distributed Replicated Block Device support
</code></pre>

<p>At the moment you have a vanilla 2.6.24 kernel with OpenVZ ovz006.5 (patched) and DRBD 8.3.0 RC2 (patched). The only thing left is IBCS which we will install as a module after we have compiled and booted into the OS. As for now lets go ahead and compile, install, and boot.</p>

<pre><code>time make -j7 rpm
</code></pre>

<p>The build command ‘time make -j7 rpm’ will tell you how long it took to build at the end, the -j is how many jobs it can run at once (8 cores - 1 core for OS = 7 cores) and ‘rpm’ will do package it up for you in and store it at /usr/src/redhat/RPMS{*}</p>

<p>If it compiles correctly you should get no errors, and see something like this:</p>

<pre><code>--output from compile--

real	6m27.445s
user	37m59.198s
sys	6m18.564s
</code></pre>

<p>Then navigate to /usr/src/redhat/{athlon, i386, i486, i586, i686, noarch} depending on your archetecture. Mine was in i386.</p>

<pre><code>ls
kernel-2.6.24-2.i386.rpm
pwd
/usr/src/redhat/RPMS/i386
rpm -i kernel-2.6.24-2.i386.rpm
</code></pre>

<p>You should get something like the above…</p>

<p>Then you need to make the ramdisk:</p>

<pre><code>mkinitrd /boot/initrd-2.6.24.img 2.6.24
</code></pre>

<p>After that add an entry to grub to test your new kernel with OpenVZ and DRBD.</p>

<pre><code>title CentOS (2.6.24 VZ_DRBD_IBCS)
        root(hd0,0)
        kernel /vmlinuz-2.6.24 ro root=LABEL=/
        initrd /initrd-2.6.24.img
</code></pre>

<p>If everything goes as expected, then you should boot up. If it doesn’t boot, or boots into the wrong kernel then you should check that you did everything correctly… Anywho, you should now be booted into your new kernel.</p>

<p>Lets continue by installing IBCS, and finishing up…</p>

<pre><code>pwd
/usr/src/kernels/2.6.24_vz_drbd_ibcs/ibcs
time make
</code></pre>

<p>If you received no errors, then continue edit /etc/rc.local to startup icbs on startup. Add the following to the end of your /etc/rc.local:</p>

<pre><code>/usr/src/kernels/2.6.24_vz_drbd_ibcs/ibcs/abi_ldr
</code></pre>

<p>You could move abi_ldr to /usr/bin if you would like, and just make sure to have the path above correspond where you decide to put abi_ldr.</p>

<p>You’re Finished!</p>

<p>Resources:
<a href="http://www.drbd.org/users-guide/s-build-from-source.html">http://www.drbd.org/users-guide/s-build-from-source.html</a>
<a href="http://wiki.openvz.org/Download/kernel/2.6.24/2.6.24-ovz006.5">http://wiki.openvz.org/Download/kernel/2.6.24/2.6.24-ovz006.5</a>
<a href="http://www.howtoforge.com/kernel_compilation_centos">http://www.howtoforge.com/kernel_compilation_centos</a></p>

    <hr>

	<h3>Related posts</h3>
	<ul>
		
		  <li><a href="/kernel-compilation-arch-linux">Kernel Compilation &amp; Arch Linux <i>(March 31, 2009)</i></a></li>
		  
		  <li><a href="/rtorrent-the-complete-guide">rTorrent -- The complete guide <i>(December 31, 2011)</i></a></li>
		  
		  <li><a href="/2-6-18-i686-pae-openvz-newest-drbd-8-3-0">2.6.18 {i686 - PAE} [OpenVZ *newest* | DRBD 8.3.0 <i>(February 09, 2009)</i></a></li>
		  
		  <li><a href="/review-pc-engines-alix6e1">[Review] PC-Engines alix6e1 <i>(November 07, 2010)</i></a></li>
		  
		  <li><a href="/arch-linux-on-imac-arch-only">Arch Linux on iMac [Arch Only] <i>(September 21, 2010)</i></a></li>
		  
		  <li><a href="/tutorial-openvz-debian-zenoss-monitor-your-world">[Tutorial] OpenVZ - Debian - Zenoss (monitor your world) <i>(October 08, 2010)</i></a></li>
		  
		  <li><a href="/slow-zfs-zpool">Slow ZFS zpool? <i>(October 06, 2010)</i></a></li>
		  
		  <li><a href="/boot-isos-with-grub-2">Boot iso's with grub 2 <i>(January 17, 2011)</i></a></li>
		  
		  <li><a href="/review-noctua-nf-p14-flx">[Review] Noctua NF-P14 FLX <i>(December 21, 2010)</i></a></li>
		  
		  <li><a href="/my-fear-of-mutt-and-why-it-was-all-for-null">My fear of mutt, and why it was all for NULL <i>(October 24, 2011)</i></a></li>
		  
	</ul>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/how-to-create-zfs-stripe-pool" title="How to create zfs stripe (pool) [NAS]">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/remove-open-solaris-gui" title="Remove Open Solaris GUI">Next &rarr;</a></li>
      
      </ul>
    </div>
  </div>

  <div class="">
    <h4>Published</h4>
    <div class="date"><span>11 December 2008</span></div>

  
    <h4>Tags</h4>
    <ul class="tag_box">
    
    


  
     
    	<li><a href="/tags.html#CentOS-ref">CentOS <span>2</span></a></li>
     
    	<li><a href="/tags.html#kernel-ref">kernel <span>5</span></a></li>
     
    	<li><a href="/tags.html#Linux-ref">Linux <span>19</span></a></li>
     
    	<li><a href="/tags.html#OpenVZ-ref">OpenVZ <span>7</span></a></li>
    
  



    </ul>
  
  </div>
</div>

<div class="row">
  <div class="span10 offset2">
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'fsk141'; // required: replace example with your forum shortname
    var disqus_identifier = '46 http://fsk141.com/?p=46';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


			  </div>

		  </div>
	  </div>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="/assets/themes/fsk141/js/jquery.min.js"><\/script>')</script>
    <script src="/assets/themes/fsk141/js/bootstrap.min.js"></script>

<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u=(("https:" == document.location.protocol) ? "https" : "http") + "://analytics.fsk141.com/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 1]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; g.type='text/javascript';
    g.defer=true; g.async=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="http://analytics.fsk141.com/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->

  </body>
</html>

